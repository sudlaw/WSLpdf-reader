
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PDF Viewer with Tracking</title>
  <style>
    #viewer-container {
      width: 100%;
      height: 90vh;
      border: 1px solid #ccc;
      overflow: scroll;
    }
    .annotator {
      position: absolute;
      background-color: yellow;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <h1>PDF Viewer with Full xAPI Tracking</h1>
  <iframe id="pdfFrame" src="../pdfs/sample.pdf" width="100%" height="600px"></iframe>

  <script src="../js/xapiwrapper.min.js"></script>
  <script src="../js/pdf-annotate.min.js"></script>
  <script>
    function getQueryParam(param) {
      const url = new URL(window.location.href);
      return url.searchParams.get(param);
    }

    const actor = {
      name: getQueryParam('name') || 'Anonymous',
      mbox: 'mailto:' + (getQueryParam('email') || 'anonymous@example.com')
    };

    ADL.XAPIWrapper.changeConfig({
      endpoint: "https://sruproject.lrs.io/xapi/",
      auth: "Basic " + btoa("4fe1cb98-7462-4981-9fac-e0d1e4a32b61:5453f299-f417-434d-8d00-43f51ff435a1"),
      actor: actor
    });

    const startTime = Date.now();
    ADL.XAPIWrapper.sendStatement({
      actor: actor,
      verb: {
        id: "http://adlnet.gov/expapi/verbs/launched",
        display: { "en-US": "launched" }
      },
      object: { id: window.location.href },
      timestamp: new Date().toISOString()
    });

    window.addEventListener("beforeunload", function () {
      const endTime = Date.now();
      const duration = (endTime - startTime) / 1000;
      ADL.XAPIWrapper.sendStatement({
        actor: actor,
        verb: {
          id: "http://adlnet.gov/expapi/verbs/exited",
          display: { "en-US": "exited" }
        },
        object: { id: window.location.href },
        result: {
          duration: "PT" + Math.round(duration) + "S"
        },
        timestamp: new Date().toISOString()
      });
    });

    // Mousemove for viewport tracking
    let lastMouseTrack = 0;
    document.addEventListener("mousemove", function (e) {
      const now = Date.now();
      if (now - lastMouseTrack > 5000) {
        lastMouseTrack = now;
        ADL.XAPIWrapper.sendStatement({
          actor: actor,
          verb: {
            id: "https://w3id.org/xapi/adb/verbs/moved-mouse",
            display: { "en-US": "moved mouse" }
          },
          object: { id: window.location.href },
          result: {
            extensions: {
              x: e.clientX,
              y: e.clientY
            }
          },
          timestamp: new Date().toISOString()
        });
      }
    });

    // Highlighting
    document.addEventListener("mouseup", function () {
      const selectedText = window.getSelection().toString().trim();
      if (selectedText.length > 5) {
        ADL.XAPIWrapper.sendStatement({
          actor: actor,
          verb: {
            id: "https://w3id.org/xapi/adb/verbs/highlighted",
            display: { "en-US": "highlighted" }
          },
          object: { id: window.location.href },
          result: { response: selectedText },
          timestamp: new Date().toISOString()
        });
      }
    });

    // Annotation (prompt input simulation)
    function promptAnnotation() {
      const note = prompt("Type annotation:");
      if (note && note.length > 0) {
        ADL.XAPIWrapper.sendStatement({
          actor: actor,
          verb: {
            id: "https://w3id.org/xapi/adb/verbs/annotated",
            display: { "en-US": "annotated" }
          },
          object: { id: window.location.href },
          result: { response: note },
          timestamp: new Date().toISOString()
        });
      }
    }

    const btn = document.createElement("button");
    btn.innerText = "Add Annotation";
    btn.style.position = "fixed";
    btn.style.bottom = "20px";
    btn.style.right = "20px";
    btn.onclick = promptAnnotation;
    document.body.appendChild(btn);
  </script>
</body>
</html>
