
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PDF.js Annotate with Tracking</title>
  <style>
    #viewerContainer {
      height: 90vh;
      overflow: auto;
      border: 1px solid #ccc;
    }
    canvas {
      display: block;
      margin: 0 auto 10px;
    }
  </style>
</head>
<body>
  <h2>PDF Reader with Canvas Tracking</h2>
  <div id="viewerContainer"></div>

  <script src="js/pdf.js"></script>
  <script src="js/pdf-annotate.min.js"></script>
  <script src="js/xapiwrapper.min.js"></script>
  <script>
    const actor = {
      name: "Student A",
      mbox: "mailto:student@example.com"
    };

    ADL.XAPIWrapper.changeConfig({
      endpoint: "https://sruproject.lrs.io/xapi/",
      auth: "Basic " + btoa("4fe1cb98-7462-4981-9fac-e0d1e4a32b61:5453f299-f417-434d-8d00-43f51ff435a1"),
      actor: actor
    });

    const url = '../pdfs/sample.pdf';
    const container = document.getElementById('viewerContainer');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.js';

    pdfjsLib.getDocument(url).promise.then(pdfDoc => {
      for (let i = 1; i <= pdfDoc.numPages; i++) {
        pdfDoc.getPage(i).then(page => {
          const scale = 1.5;
          const viewport = page.getViewport({ scale });
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          canvas.dataset.pageNumber = i;

          page.render({ canvasContext: context, viewport }).promise.then(() => {
            container.appendChild(canvas);
          });

          canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ADL.XAPIWrapper.sendStatement({
              actor: actor,
              verb: {
                id: "https://w3id.org/xapi/adb/verbs/clicked",
                display: { "en-US": "clicked" }
              },
              object: {
                id: url + "#page=" + i
              },
              result: {
                extensions: {
                  "page": i,
                  "x": Math.round(x),
                  "y": Math.round(y)
                }
              },
              timestamp: new Date().toISOString()
            });
          });

          canvas.addEventListener('dblclick', e => {
            const note = prompt("Type a note:");
            if (!note) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ADL.XAPIWrapper.sendStatement({
              actor: actor,
              verb: {
                id: "https://w3id.org/xapi/adb/verbs/annotated",
                display: { "en-US": "annotated" }
              },
              object: {
                id: url + "#page=" + i
              },
              result: {
                response: note,
                extensions: {
                  page: i,
                  x: Math.round(x),
                  y: Math.round(y)
                }
              },
              timestamp: new Date().toISOString()
            });
          });
        });
      }
    }).catch(err => {
      container.innerHTML = "<p style='color:red;'>Failed to load PDF: " + err.message + "</p>";
    });
  </script>
</body>
</html>
