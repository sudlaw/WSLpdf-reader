
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PDF Annotate Tracker</title>
  <style>
    #viewerContainer {
      height: 90vh;
      overflow: scroll;
      border: 1px solid #aaa;
    }
    canvas {
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h2>PDF Annotation Tracker</h2>
  <div id="viewerContainer"></div>

  <script src="js/pdf.js"></script>
  <script src="js/pdf-annotate.min.js"></script>
  <script src="js/xapiwrapper.min.js"></script>

  <script>
    // config
    const url = '../pdfs/sample.pdf';
    const actor = {
      name: 'Student A',
      mbox: 'mailto:studentA@example.com'
    };

    ADL.XAPIWrapper.changeConfig({
      endpoint: "https://sruproject.lrs.io/xapi/",
      auth: "Basic " + btoa("4fe1cb98-7462-4981-9fac-e0d1e4a32b61:5453f299-f417-434d-8d00-43f51ff435a1"),
      actor: actor
    });

    // load PDF
    const container = document.getElementById('viewerContainer');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf.worker.js';

    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
      for (let i = 1; i <= pdfDoc_.numPages; i++) {
        pdfDoc_.getPage(i).then(function(page) {
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          canvas.dataset.pageNumber = i;
          const ctx = canvas.getContext('2d');
          page.render({ canvasContext: ctx, viewport: viewport });

          canvas.addEventListener('click', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ADL.XAPIWrapper.sendStatement({
              actor: actor,
              verb: {
                id: "https://w3id.org/xapi/adb/verbs/clicked",
                display: { "en-US": "clicked" }
              },
              object: {
                id: url + "#page=" + i
              },
              result: {
                extensions: {
                  "page": i,
                  "x": Math.round(x),
                  "y": Math.round(y)
                }
              },
              timestamp: new Date().toISOString()
            });
          });

          container.appendChild(canvas);
        });
      }
    });

    // annotation event example
    container.addEventListener('dblclick', function(e) {
      const note = prompt('Enter annotation:');
      if (!note) return;

      const target = e.target.closest('canvas');
      if (!target) return;
      const rect = target.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const page = target.dataset.pageNumber;

      ADL.XAPIWrapper.sendStatement({
        actor: actor,
        verb: {
          id: "https://w3id.org/xapi/adb/verbs/annotated",
          display: { "en-US": "annotated" }
        },
        object: {
          id: url + "#page=" + page
        },
        result: {
          response: note,
          extensions: {
            page: parseInt(page),
            x: Math.round(x),
            y: Math.round(y)
          }
        },
        timestamp: new Date().toISOString()
      });
    });
  </script>
</body>
</html>
